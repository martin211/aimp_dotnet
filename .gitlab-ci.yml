variables:
  VERSION: "$AIMP_VERSION.$CI_JOB_ID"
  AimpDotnetProj: "$env:CI_PROJECT_DIR/Build/AimpDotnet.proj"
  DebugBuildParameters: "-projectParameters '/p:Version=$env:VERSION /p:Configuration=Debug /p:DeploymentFolder=artifacts'" -BuildLogDirectoryPath "$env:CI_PROJECT_DIR/Build/logs" -KeepBuildLogOnSuccessfulBuilds -ShowBuildOutputInCurrentWindow
  ReleaseBuildParameters: "-projectParameters '/p:Version=$env:VERSION /p:Configuration=Release /p:DeploymentFolder=artifacts'" -BuildLogDirectoryPath "$env:CI_PROJECT_DIR/Build/logs" -KeepBuildLogOnSuccessfulBuilds -ShowBuildOutputInCurrentWindow

stages:
  - analysis_start
  - build
  - analysis_end
  - artifacts
  - zip_publish
  - documentation
  - publish_documentation
  - deploy

docker_start:
  stage: analysis_start
  except:
    - master
  script:
  - Import-Module CiBuildTools
  - Start-DockerContainer -containerName "dev.mysql"
  - Start-DockerContainer -containerName "dev.sonarqube"

analysis_start:
  stage: analysis_start
  except:
    - master
  script:
  - Import-Module CiBuildTools
  - Invoke-StartSonarQube -solutionPath $env:CI_PROJECT_DIR\src\aimp_dotnet.sln -sonarProjectKey $env:SONAR_PROJECT_KEY -sonarProjectName aimp_dotnet -version $env:VERSION -branch $env:CI_COMMIT_REF_NAME

analysis_end:
  stage: analysis_end
  except:
    - master
  script:
  - Import-Module CiBuildTools
  - Invoke-StopSonarQube

set_version:
  stage: build
  script:
  - Import-Module CiBuildTools
  - Invoke-SetCliVersion -rcFilePath "$env:CI_PROJECT_DIR\src\aimp_dotnet\aimp_dotnet.rc" -contentToReplace "1.0.0.1" -replaceTo "$env:VERSION"
  - Invoke-SetCliVersion -rcFilePath "$env:CI_PROJECT_DIR\src\aimp_dotnet\aimp_dotnet.rc" -contentToReplace "1,0,0,1" -replaceTo $env:VERSION.Replace(".", ",")

build_master:
  only:
    - master
  stage: build
  script:
  - Import-Module CiBuildTools  
  - Invoke-BuildProject -Path $env:AimpDotnetProj -target Default $env:ReleaseBuildParameters

build_develop:
  only:
    - develop
  stage: build
  script:
  - Import-Module CiBuildTools  
  - Invoke-BuildProject -Path $env:AimpDotnetProj -target Default $env:DebugBuildParameters

prepare_artifacts:
  only:
    - master
    - develop
  except:
    - tags
  stage: artifacts
  script:
  - Import-Module CiBuildTools
  - Invoke-BuildProject -Path $env:AimpDotnetProj -target CopyArtifacts $env:ReleaseBuildParameters

compress_artifacts:
  only:
    - master
    - develop
  except:
    - tags
  stage: artifacts
  script:
  - Import-Module CiBuildTools
  - Invoke-BuildProject -Path $env:AimpDotnetProj -target MakeZip $env:ReleaseBuildParameters
  artifacts:
    paths:
      - $env:CI_PROJECT_DIR/Build/artifacts/AIMP.SDK.zip
      - $env:CI_PROJECT_DIR/Build/logs/*

documentation_build:
  only:
    - master
  stage: documentation
  script: 
  - Import-Module CiBuildTools
  - Invoke-BuildDocumentation

documentation_publish:
  only:
    - master
  stage: publish_documentation
  script: 
  - Import-Module CiBuildTools
  - Invoke-BuildDocumentation

publish_to_release:
  stage: deploy
  only:
    - master
  environment:
    name: Production
  script:
  - Import-Module CiBuildTools
  - New-GitTag -tagName $env:VERSION